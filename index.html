<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Live input record and playback</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
  <style type='text/css'>
    ul { list-style: none; }
    #recordingslist audio { display: block; margin-bottom: 10px; }
  </style>
</head>
<body>
<div class="container">
 <div class="row">
  <div class="col-lg-6 offset-lg-3">
    <table class="table">
      <tr>
        <td><button class="btn btn-lg btn-default">1</button></td><td><button class="btn btn-lg btn-default">2</button></td><td><button class="btn btn-lg btn-default">3</button></td>
      </tr>
      <tr>
        <td><button class="btn btn-lg btn-default">4</button></td><td><button class="btn btn-lg btn-default">5</button></td><td><button class="btn btn-lg btn-default">6</button></td>
      </tr>
      <tr>
        <td><button class="btn btn-lg btn-default">7</button></td><td><button class="btn btn-lg btn-default">8</button></td><td><button class="btn btn-lg btn-default">9</button></td>
      </tr>
    </table>
  </div>
  <div class="col-lg-4">
    <button class="btn btn-danger" onclick="startRecording(this);">record</button>
    <button class="btn btn-info" onclick="stopRecording(this);" disabled>stop</button>
    <hr />
    <h2>Log</h2>
    <pre id="log"></pre>
  </div>
  <div class="col-lg-8">
    <h2 class="text-center">Recordings</h2>
    <ul id="recordingslist"></ul>
  </div>
<!--   <div class="col-lg-12">
    <h2>Log</h2>
    <pre id="log"></pre>
  </div> -->

 </div>
</div>
  <script>
  function __log(e, data) {
    log.innerHTML += "\n" + e + " " + (data || '');
  }

  var audio_context;
  var recorder;

  function startUserMedia(stream) {
    var input = audio_context.createMediaStreamSource(stream);
    __log('Media stream created.');

    // Uncomment if you want the audio to feedback directly
    //input.connect(audio_context.destination);
    //__log('Input connected to audio context destination.');
    
    recorder = new Recorder(input);
    __log('Recorder initialised.');
  }

  function startRecording(button) {
    recorder && recorder.record();
    button.disabled = true;
    button.nextElementSibling.disabled = false;
    __log('Recording...');
  }

  function stopRecording(button) {
    recorder && recorder.stop();
    button.disabled = true;
    button.previousElementSibling.disabled = false;
    __log('Stopped recording.');
    
    // create WAV download link using audio data blob
    createDownloadLink();
    
    recorder.clear();
  }

  function createDownloadLink() {
    recorder && recorder.exportWAV(function(blob) {
      var url = URL.createObjectURL(blob);
      var li = document.createElement('div');
      li.className = "row";
      var au = document.createElement('audio');
      var auW = document.createElement('div');
      auW.className = 'col-lg-9';
      // var hf = document.createElement('a');

      // var keyB = document.createElement('button');
      
      au.controls = true;
      au.src = url;
      au.setAttribute("id", "audioXYZ");

      auW.appendChild(au);
      // hf.href = url;
      // hf.download = new Date().toISOString() + '.wav';
      // hf.innerHTML = hf.download;
      // keyB.innerHTML = "PRESS 1";
      // keyB.setAttribute("id", "press_audioXYZ");
      var btnString = '<div class="col-lg-3"><button class="btn btn-warning pull-left">PRESS 1</button></div>';

      li.innerHTML = btnString;

      li.appendChild(auW);
      // li.appendChild(keyB);
      // li.appendChild(hf);
      recordingslist.appendChild(li);
    });
  }

  window.onload = function init() {
    try {
      // webkit shim
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
      window.URL = window.URL || window.webkitURL;
      
      audio_context = new AudioContext;
      __log('Audio context set up.');
      __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
    } catch (e) {
      alert('No web audio support in this browser!');
    }
    
    navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
      __log('No live audio input: ' + e);
    });
  };
  </script>

  <script src="recorder.js"></script>
</body>
</html>